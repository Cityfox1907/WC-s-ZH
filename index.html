<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Z√ºriHub ‚Äì Gastronomie-Datenbank Kanton Z√ºrich</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçΩÔ∏è</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Fraunces:opsz,wght@9..144,600;9..144,700;9..144,800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="design-tokens.css">
<script>
var _pdfReady=false;
function _ls(u){return new Promise(function(ok,no){var s=document.createElement('script');s.src=u;s.onload=ok;s.onerror=no;document.head.appendChild(s)})}
(async function(){
  var a=['https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js','https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'];
  var b=['https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js','https://unpkg.com/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js'];
  for(var i=0;i<a.length;i++){try{await _ls(a[i]);break}catch(e){}}
  for(var j=0;j<b.length;j++){try{await _ls(b[j]);break}catch(e){}}
  if(window.jspdf)_pdfReady=true;
})();
</script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#F4F7FB;--surface:#FFFFFF;--surface2:#EBF0F7;--border:#D4DCE8;--border-light:#E8EDF5;
  --text:#0D1B2A;--text2:#4A5568;--text3:#8896A6;
  --primary:#0F47AF;--primary-light:#E8EEFB;--primary-lighter:#F2F5FC;--primary-dark:#0A3580;--primary-50:rgba(15,71,175,.06);
  --accent:#E63946;--accent-light:#FEF0F1;
  --gold:#D4930D;
  --radius:14px;--radius-sm:6px;
  --shadow:0 1px 3px rgba(13,27,42,.05),0 1px 2px rgba(13,27,42,.03);
  --shadow-md:0 4px 14px rgba(13,27,42,.08);--shadow-lg:0 12px 36px rgba(13,27,42,.12);
  --font:'Outfit',system-ui,sans-serif;--font-display:'Fraunces',Georgia,serif;
  --card-bg:#FFFFFF;--header-bg:rgba(255,255,255,.92);--sidebar-bg:#fff;
  --modal-bg:#fff;--modal-overlay:rgba(13,27,42,.35);
  --splash-bg:var(--primary);
}

/* ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ */
html.dark{
  --bg:#0f1b2d;--surface:#1a2a3a;--surface2:#1e3148;--border:#2a3f58;--border-light:#243650;
  --text:#e8ecf2;--text2:#a8b8cc;--text3:#6b7f96;
  --primary:#5a9cf5;--primary-light:#1e3148;--primary-lighter:#162538;--primary-dark:#7bb8ff;--primary-50:rgba(90,156,245,.08);
  --accent:#ff6b78;--accent-light:#2a1820;
  --gold:#f5a623;
  --shadow:0 1px 3px rgba(0,0,0,.2),0 1px 2px rgba(0,0,0,.15);
  --shadow-md:0 4px 14px rgba(0,0,0,.3);--shadow-lg:0 12px 36px rgba(0,0,0,.4);
  --card-bg:#1a2a3a;--header-bg:rgba(15,27,45,.92);--sidebar-bg:#152235;
  --modal-bg:#1a2a3a;--modal-overlay:rgba(5,10,20,.6);
  --splash-bg:#0f1b2d;
}
html.dark input[type="range"]{background:var(--border)}
html.dark input[type="range"]::-webkit-slider-thumb{border-color:var(--surface)}
html.dark .card{background:var(--card-bg)}
html.dark .header{background:var(--header-bg)}
html.dark .sidebar{background:var(--sidebar-bg)}
html.dark .mp{background:var(--modal-bg)}
html.dark .mo{background:var(--modal-overlay)}
html.dark .hbtn{background:var(--surface);border-color:var(--border);color:var(--text2)}
html.dark .hbtn:hover{border-color:var(--primary);color:var(--primary)}
html.dark .tb{background:var(--surface);border-color:var(--border);color:var(--text2)}
html.dark .tb.on{background:var(--primary);color:#fff;border-color:var(--primary)}
html.dark .smenu,.dark .exp-menu{background:var(--surface);border-color:var(--border)}
html.dark .sopt:hover{background:var(--surface2)}
html.dark .mclose{background:rgba(26,42,58,.94)}
html.dark .search-box input{background:var(--surface2);border-color:var(--border);color:var(--text)}
html.dark .search-box input:focus{border-color:var(--primary);background:var(--surface);box-shadow:0 0 0 3px rgba(90,156,245,.15)}
html.dark .cs-input{background:var(--surface2);border-color:var(--border);color:var(--text)}
html.dark .geo-input input{background:var(--surface2);border-color:var(--border);color:var(--text)}
html.dark .tag{background:var(--surface2);color:var(--text2)}
html.dark .pb{background:var(--surface);border-color:var(--border);color:var(--text2)}
html.dark .pb.on{background:var(--primary);color:#fff;border-color:var(--primary)}
html.dark .ltbl th{background:var(--surface2);color:var(--text3);border-bottom-color:var(--border)}
html.dark .ltbl td{border-bottom-color:var(--border-light)}
html.dark .ltbl tbody tr:nth-child(even){background:var(--primary-50)}
html.dark .ltbl tbody tr:hover{background:var(--primary-lighter)}
html.dark .btn-s{background:var(--surface);color:var(--text2);border-color:var(--border)}
html.dark .btn-s:hover{border-color:var(--primary);color:var(--primary)}
html.dark .chip{background:var(--primary-light);color:var(--primary-dark)}
html.dark .drop-zone{border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.04)}
html.dark .card-trade{background:var(--primary-light);color:var(--primary)}
html.dark .rank-badge{background:#e8914a;color:#fff;box-shadow:0 2px 8px rgba(232,145,74,.4)}
html.dark .rank-badge.top3{background:linear-gradient(135deg,#e8914a,#f5a623)}
html.dark .fav-star{color:#6b7f96}
html.dark .fav-star.active{color:#f5a623;text-shadow:0 0 8px rgba(245,166,35,.5)}
/* Dark mode: filter chips */
html.dark .filter-chip{background:var(--surface);border-color:var(--border);color:var(--text2)}
html.dark .filter-chip.on{background:var(--primary);color:#fff;border-color:var(--primary)}
html.dark .filter-chip:hover{border-color:var(--primary);color:var(--primary)}
html.dark .filter-section-label{color:var(--text3)}
/* Dark mode: GPS button */
html.dark .btn-gps{background:var(--surface);border-color:var(--border);color:var(--text2)}
html.dark .btn-gps:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
html.dark .btn-gps.active{background:var(--primary);border-color:var(--primary);color:#fff}
/* Dark mode: maps button */
html.dark .btn-maps{background:var(--surface2);border-color:var(--border);color:var(--text2)}
html.dark .btn-maps:hover{background:var(--surface);border-color:var(--primary);color:var(--primary)}

html{font-family:var(--font);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;overflow-x:hidden;transition:background .3s,color .3s}
body{min-height:100vh;overflow-x:hidden}
input,select,button,textarea{font-family:inherit;font-size:inherit}
button{cursor:pointer;border:none;background:none}
a{color:inherit;text-decoration:none}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
.fade-up{animation:fadeUp .4s ease both}

/* SPLASH */
#splash{position:fixed;inset:0;background:var(--splash-bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;transition:opacity .5s,visibility .5s}
#splash.done{opacity:0;visibility:hidden}
#splash::before{content:'';position:absolute;top:0;right:0;width:50%;height:100%;background:rgba(255,255,255,.06);clip-path:polygon(30% 0,100% 0,100% 100%,0 100%)}
.splash-logo{font-family:var(--font-display);font-size:clamp(2rem,5vw,3rem);font-weight:800;position:relative;z-index:1}
.splash-sub{font-size:.95rem;opacity:.7;margin-top:.5rem;position:relative;z-index:1}
.splash-spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .65s linear infinite;margin-top:2rem;position:relative;z-index:1}
.splash-msg{font-size:.85rem;opacity:.6;margin-top:1rem;position:relative;z-index:1}
.splash-bar{width:200px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;margin-top:.75rem;position:relative;z-index:1}
.splash-bar-inner{height:100%;width:0%;background:#fff;border-radius:2px;transition:width .3s}
.splash-upload{display:none;margin-top:1.5rem;position:relative;z-index:1;text-align:center}
.splash-upload.show{display:block}
.drop-zone{width:340px;max-width:90vw;border:2px dashed rgba(255,255,255,.35);border-radius:14px;padding:2rem 1.5rem;cursor:pointer;transition:all .25s;position:relative;background:rgba(255,255,255,.06)}
.drop-zone:hover,.drop-zone.over{border-color:rgba(255,255,255,.7);background:rgba(255,255,255,.12);transform:scale(1.02)}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.drop-icon{font-size:2.2rem;margin-bottom:.5rem;display:block}
.drop-text{font-size:.9rem;opacity:.85;line-height:1.6}
.drop-hint{font-size:.75rem;opacity:.45;margin-top:.4rem}

/* HEADER */
.header{position:sticky;top:0;z-index:100;background:var(--header-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border-light);padding:.55rem 1.25rem;transition:background .3s}
.header-inner{max-width:1480px;margin:0 auto;display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.logo{font-family:var(--font-display);font-size:1.25rem;font-weight:800;color:var(--primary);white-space:nowrap;flex-shrink:0;letter-spacing:-.02em;display:inline-flex;align-items:center;gap:.4rem;text-decoration:none}
.logo-icon{flex-shrink:0;display:block}
.search-box{flex:1;min-width:180px;max-width:460px;position:relative}
.search-box input{width:100%;padding:.5rem .85rem .5rem 2.2rem;border:1.5px solid var(--border);border-radius:var(--radius);background:var(--bg);font-size:.87rem;transition:all .2s;outline:none;color:var(--text)}
.search-box input:focus{border-color:var(--primary);background:var(--surface);box-shadow:0 0 0 3px rgba(15,71,175,.1)}
.search-box input::placeholder{color:var(--text3)}
.search-box svg{position:absolute;left:.7rem;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none}
.hactions{display:flex;gap:.35rem;align-items:center;margin-left:auto;flex-wrap:wrap}
.hbtn{padding:.42rem .7rem;border-radius:var(--radius-sm);font-size:.8rem;font-weight:500;color:var(--text2);border:1.5px solid var(--border);background:var(--surface);transition:all .18s;display:inline-flex;align-items:center;gap:.3rem;white-space:nowrap}
.hbtn:hover{border-color:var(--primary);color:var(--primary)}
.hbtn svg{width:15px;height:15px;flex-shrink:0}
.vtog{display:inline-flex;border:1.5px solid var(--border);border-radius:var(--radius-sm);overflow:hidden}
.vtog button{padding:.38rem .55rem;background:var(--surface);border:none;color:var(--text3);transition:all .15s;display:flex;align-items:center}
.vtog button.on{background:var(--primary);color:#fff}
.vtog button:not(:last-child){border-right:1.5px solid var(--border)}
html.dark .vtog button{background:var(--surface);color:var(--text3)}
html.dark .vtog button.on{background:var(--primary);color:#fff}

/* ‚îÄ‚îÄ THEME TOGGLE ‚îÄ‚îÄ */
.theme-toggle{position:relative;width:52px;height:28px;border-radius:14px;background:var(--border);cursor:pointer;border:1.5px solid var(--border);transition:all .3s;flex-shrink:0;display:flex;align-items:center}
.theme-toggle .toggle-knob{position:absolute;left:2px;width:22px;height:22px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.15);transition:transform .3s cubic-bezier(.4,.0,.2,1);display:flex;align-items:center;justify-content:center;font-size:.7rem}
.theme-toggle .toggle-icon-sun,.theme-toggle .toggle-icon-moon{position:absolute;font-size:.75rem;transition:opacity .25s}
.theme-toggle .toggle-icon-sun{right:6px;opacity:1}
.theme-toggle .toggle-icon-moon{left:6px;opacity:0}
html.dark .theme-toggle{background:#1e3148;border-color:#2a3f58}
html.dark .theme-toggle .toggle-knob{transform:translateX(24px);background:#e8914a}
html.dark .theme-toggle .toggle-icon-sun{opacity:0}
html.dark .theme-toggle .toggle-icon-moon{opacity:1}

/* STATS */
.stats{max-width:1480px;margin:0 auto;padding:.45rem 1.25rem;display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;font-size:.82rem;color:var(--text2)}
.rcnt b{color:var(--primary);font-weight:700}
.chips{display:flex;flex-wrap:wrap;gap:.3rem;align-items:center}
.chip{display:inline-flex;align-items:center;gap:.15rem;padding:.18rem .45rem;background:var(--primary-light);color:var(--primary-dark);border-radius:20px;font-size:.74rem;font-weight:500;white-space:nowrap}
.chip-x{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;color:var(--primary-dark);opacity:.5;transition:all .12s;cursor:pointer;font-size:.68rem;border:none;background:none;padding:0;font-family:inherit;line-height:1}
.chip-x:hover{opacity:1;background:rgba(15,71,175,.15)}
.chip-clear{font-size:.74rem;color:var(--accent);font-weight:600;padding:.18rem .4rem;border-radius:var(--radius-sm);transition:background .12s}
.chip-clear:hover{background:var(--accent-light)}

/* LAYOUT */
.layout{max-width:1480px;margin:0 auto;display:flex;position:relative;overflow-x:hidden}
.fov{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:149;display:none}.fov.on{display:block}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{width:280px;min-width:280px;border-right:1px solid var(--border-light);background:var(--sidebar-bg);padding:.75rem 1rem;overflow-y:auto;max-height:calc(100vh - 102px);position:sticky;top:102px;transition:transform .3s,background .3s}
.fs{margin-bottom:.85rem;padding-bottom:.85rem;border-bottom:1px solid var(--border-light)}.fs:last-child{border-bottom:none}
.fl{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text3);margin-bottom:.45rem;display:flex;align-items:center;justify-content:space-between}
.fl button{font-size:.68rem;color:var(--primary);font-weight:600}

/* ‚îÄ‚îÄ Filter section accordion labels ‚îÄ‚îÄ */
.filter-section-label{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--text3);padding:.4rem 0;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;border:none;background:none;width:100%}
.filter-section-label::after{content:'‚Ä∫';font-size:.85rem;transition:transform .2s;opacity:.5}
.filter-section-label.open::after{transform:rotate(90deg)}
.filter-section-body{display:none;padding-bottom:.3rem}
.filter-section-body.open{display:block}

/* ‚îÄ‚îÄ Filter chips grid (2 columns) ‚îÄ‚îÄ */
.filter-chips-grid{display:grid;grid-template-columns:1fr 1fr;gap:.3rem}
.filter-chip{padding:.28rem .45rem;border-radius:8px;font-size:.73rem;font-weight:500;border:1.5px solid var(--border);color:var(--text2);background:var(--surface);transition:all .15s;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;display:block;width:100%}
.filter-chip:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-lighter)}
.filter-chip.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.filter-chip .chip-count{font-size:.62rem;opacity:.5;margin-left:.15rem}

/* Legacy tag buttons (Betriebsart, Standort) */
.tg{display:flex;flex-wrap:wrap;gap:.28rem}
.tb{padding:.22rem .5rem;border-radius:20px;font-size:.74rem;border:1.5px solid var(--border);color:var(--text2);background:var(--surface);transition:all .15s;white-space:nowrap;line-height:1.4}
.tb:hover{border-color:var(--primary);color:var(--primary)}
.tb.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.tb .n{font-size:.66rem;opacity:.55;margin-left:.15rem}
.cs-input{width:100%;padding:.38rem .55rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.8rem;margin-bottom:.35rem;outline:none;transition:border-color .15s;background:var(--bg);color:var(--text)}
.cs-input:focus{border-color:var(--primary);background:var(--surface)}
.clist{max-height:170px;overflow-y:auto}
.ci{display:flex;align-items:center;gap:.35rem;padding:.22rem 0;font-size:.78rem;cursor:pointer;color:var(--text2);transition:color .12s}
.ci:hover{color:var(--text)}
.ci input{accent-color:var(--primary);width:13px;height:13px;flex-shrink:0}
.ci .n{margin-left:auto;font-size:.68rem;color:var(--text3)}
.rng{margin-bottom:.35rem}
.rng label{font-size:.78rem;color:var(--text2);display:flex;justify-content:space-between;margin-bottom:.2rem}
.rng label b{font-weight:700;color:var(--primary)}
input[type="range"]{-webkit-appearance:none;width:100%;height:4px;border-radius:2px;background:var(--border);outline:none;margin:.25rem 0}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--primary);cursor:pointer;border:2.5px solid var(--surface);box-shadow:0 1px 4px rgba(0,0,0,.15)}
.rpre{display:flex;flex-wrap:wrap;gap:.22rem;margin-top:.3rem}

/* CONTENT */
.content{flex:1;padding:.75rem 1.25rem;min-width:0;overflow-x:hidden}

/* ‚îÄ‚îÄ GRID: fixed 2 columns ‚îÄ‚îÄ */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.85rem;overflow:visible;padding-top:4px;align-items:stretch}
@media(max-width:640px){.grid{grid-template-columns:1fr}}

/* ‚îÄ‚îÄ CARD: column layout, equal heights in grid ‚îÄ‚îÄ */
.card{background:var(--card-bg);border:1.5px solid var(--border-light);border-radius:14px;padding:.95rem 1rem;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;position:relative;overflow:hidden;margin-top:8px;height:100%}
.card:hover{box-shadow:0 6px 24px rgba(15,71,175,0.13);border-color:rgba(15,71,175,0.25);transform:translateY(-2px)}
/* Header: rank badge left + trade right */
.card-header{display:flex;align-items:center;gap:.4rem;margin-bottom:.55rem}
.card-trade{font-size:.7rem;font-weight:600;padding:.15rem .45rem;border-radius:10px;background:var(--primary-light);color:var(--primary);white-space:nowrap;flex-shrink:0}
/* Row: photo + content side by side */
.card-main-row{display:flex;flex-direction:row;align-items:flex-start;gap:.85rem;margin-bottom:.65rem}
.card-content{flex:1;min-width:0;display:flex;flex-direction:column;gap:.22rem}
.card-name{font-weight:700;font-size:1rem;line-height:1.3;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card-addr{font-size:.875rem;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:.25rem;line-height:1.4}
.card-addr svg{width:13px;height:13px;color:var(--text3);flex-shrink:0}
.card-addr-text{overflow:hidden;text-overflow:ellipsis}
.card-rating{display:flex;align-items:center;gap:.4rem;margin-top:.1rem}
.stars{display:inline-flex;gap:1px;color:var(--gold)}.stars svg{width:13px;height:13px}.stars .e{color:var(--border)}
.card-score{font-weight:700;font-size:.9rem;color:var(--text)}.card-reviews{font-size:.8rem;color:var(--text3)}
/* Footer: tags left, maps button right */
.card-footer{display:flex;align-items:center;justify-content:space-between;margin-top:auto;padding-top:.6rem;border-top:1px solid var(--border-light);gap:.5rem}
.card-tags{display:flex;flex-wrap:wrap;gap:.22rem;flex:1;min-width:0}
.card-icon{width:46px;height:46px;min-width:46px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.35rem;flex-shrink:0}
.ci-restaurant{background:linear-gradient(135deg,#FFF5F5,#FED7D7)}
.ci-bar{background:linear-gradient(135deg,#FFFFF0,#FEFCBF)}
.ci-caf√©{background:linear-gradient(135deg,#FFF8F1,#FEEBC8)}
.ci-hotel{background:linear-gradient(135deg,#EBF8FF,#BEE3F8)}
.ci-b√§ckerei{background:linear-gradient(135deg,#FFFAF0,#FEEBC8)}
.ci-takeaway{background:linear-gradient(135deg,#F0FFF4,#C6F6D5)}
.ci-einkaufszentrum{background:linear-gradient(135deg,#F5F3FF,#E9D8FD)}
.ci-default{background:linear-gradient(135deg,#F7FAFC,#E2E8F0)}
html.dark .ci-restaurant{background:linear-gradient(135deg,#2a1a1a,#3a2020)}
html.dark .ci-bar{background:linear-gradient(135deg,#2a2a1a,#3a3520)}
html.dark .ci-caf√©{background:linear-gradient(135deg,#2a2418,#3a3020)}
html.dark .ci-hotel{background:linear-gradient(135deg,#1a2530,#203040)}
html.dark .ci-b√§ckerei{background:linear-gradient(135deg,#2a2518,#3a3020)}
html.dark .ci-takeaway{background:linear-gradient(135deg,#1a2a1a,#203520)}
html.dark .ci-einkaufszentrum{background:linear-gradient(135deg,#221a30,#2a2040)}
html.dark .ci-default{background:linear-gradient(135deg,#1a2030,#253040)}
.tag{padding:.15rem .5rem;border-radius:12px;font-size:.8rem;font-weight:500;background:var(--surface2);color:var(--text2);white-space:nowrap}
.kreis{display:inline-flex;align-items:center;padding:.1rem .35rem;border-radius:6px;font-size:.62rem;font-weight:700;background:var(--primary);color:#fff;white-space:nowrap;letter-spacing:.03em;flex-shrink:0}
.dist{display:inline-flex;align-items:center;gap:.15rem;padding:.1rem .38rem;border-radius:6px;font-size:.62rem;font-weight:700;background:var(--gold);color:#fff;white-space:nowrap;flex-shrink:0;letter-spacing:.01em}
.dist svg{width:10px;height:10px}

/* ‚îÄ‚îÄ Card profile photo ‚îÄ‚îÄ */
.card-photo{width:80px;height:80px;min-width:80px;border-radius:12px;object-fit:cover;object-position:center;border:2px solid var(--border-light);box-shadow:0 2px 10px rgba(0,0,0,0.10);flex-shrink:0;display:block}

/* ‚îÄ‚îÄ Google Maps Button (footer right) ‚îÄ‚îÄ */
.btn-maps{display:inline-flex;align-items:center;gap:.3rem;padding:.3rem .6rem;border-radius:7px;background:#fff;border:1.5px solid #dadce0;text-decoration:none;font-size:.72rem;font-weight:600;color:#3c4043;white-space:nowrap;flex-shrink:0;transition:all .18s;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
.btn-maps:hover{background:#f8f9fa;border-color:#bdc1c6;box-shadow:0 2px 6px rgba(0,0,0,0.12)}

/* ‚îÄ‚îÄ GPS Button ‚îÄ‚îÄ */
.btn-gps{width:38px;height:38px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .18s;flex-shrink:0;color:var(--text2)}
.btn-gps:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
.btn-gps.active{background:var(--primary);border-color:var(--primary);color:#fff}
.btn-gps.loading svg{animation:spin 1s linear infinite}

/* Geo input row with GPS */
.geo-input{display:flex;gap:.3rem;margin-bottom:.4rem;align-items:center}
.geo-input input{flex:0 1 50%;padding:.38rem .55rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.82rem;text-align:center;outline:none;background:var(--bg);transition:border-color .15s;letter-spacing:.08em;font-weight:600;color:var(--text);max-width:50%}
.geo-input input:focus{border-color:var(--primary);background:var(--surface)}
.geo-input input.err{border-color:var(--accent);background:var(--accent-light)}
.geo-input input.ok{border-color:#0D8A4A;background:#ECFDF3}
.geo-hint{font-size:.68rem;color:var(--text3);margin-bottom:.35rem}
.geo-active{font-size:.72rem;color:var(--primary);font-weight:600;margin-bottom:.35rem;display:flex;align-items:center;gap:.25rem}
.geo-active button{font-size:.68rem;color:var(--accent);font-weight:600;margin-left:auto}

/* ‚îÄ‚îÄ RANK BADGE (pill, inside card top-left) ‚îÄ‚îÄ */
.rank-badge{display:inline-flex;align-items:center;justify-content:center;padding:.18rem .55rem;border-radius:6px;background:linear-gradient(135deg,#e8a020,#d4930d);color:#fff;font-size:.72rem;font-weight:800;letter-spacing:.02em;box-shadow:0 2px 6px rgba(212,147,13,0.35);margin-bottom:.65rem;align-self:flex-start;position:static;width:auto;height:auto}
.rank-badge.top3{background:linear-gradient(135deg,#e8a020,#d4930d);box-shadow:0 2px 8px rgba(212,147,13,0.5);padding:.2rem .6rem;font-size:.75rem}

/* ‚îÄ‚îÄ FAVORITE STAR ‚îÄ‚îÄ */
.fav-star{position:absolute;top:.55rem;right:.55rem;font-size:1.25rem;cursor:pointer;color:var(--text3);opacity:.5;transition:all .2s;z-index:3;line-height:1;padding:.15rem}
.fav-star:hover{opacity:1;transform:scale(1.2)}
.fav-star.active{color:var(--gold);opacity:1;text-shadow:0 0 6px rgba(212,147,13,.3)}

/* ‚îÄ‚îÄ BACK TO TOP ‚îÄ‚îÄ */
.btt{position:fixed;bottom:1.5rem;right:1.5rem;width:44px;height:44px;border-radius:50%;background:var(--primary);color:#fff;font-size:1.1rem;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-md);cursor:pointer;border:none;z-index:90;opacity:0;visibility:hidden;transform:translateY(10px);transition:all .3s}
.btt.show{opacity:1;visibility:visible;transform:translateY(0)}
.btt:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:var(--shadow-lg)}
html.dark .btt{background:#e8914a}
html.dark .btt:hover{background:#d17f3a}

/* LIST VIEW */
.lview{display:none;overflow-x:auto}
.ltbl{width:100%;border-collapse:separate;border-spacing:0;font-size:.82rem}
.ltbl th{background:var(--surface2);padding:.55rem .65rem;text-align:left;font-weight:600;font-size:.73rem;text-transform:uppercase;letter-spacing:.04em;color:var(--text3);border-bottom:2px solid var(--border);user-select:none;white-space:nowrap}
.ltbl th.sort{cursor:pointer}
.ltbl th.sort:hover{color:var(--primary)}
.ltbl th .sa{margin-left:.2rem;opacity:.3;font-size:.7rem}
.ltbl th.sd .sa{opacity:1;color:var(--primary)}
.ltbl td{padding:.48rem .65rem;border-bottom:1px solid var(--border-light);vertical-align:middle}
.ltbl tr{transition:background .1s}
.ltbl tbody tr:hover{background:var(--primary-lighter)}
.ltbl tbody tr:nth-child(even){background:var(--primary-50)}
.ltbl tbody tr:nth-child(even):hover{background:var(--primary-lighter)}
.ltbl .nc{font-weight:600;cursor:pointer;color:var(--primary);max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ltbl .nc:hover{text-decoration:underline}
.ltbl .ac{color:var(--text2);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ltbl .link-cell a{color:var(--primary);font-weight:500;font-size:.78rem}
.ltbl .link-cell a:hover{text-decoration:underline}

/* PAGINATION */
.pag{display:flex;align-items:center;justify-content:center;gap:.35rem;margin:1.5rem 0 1rem;flex-wrap:wrap}
.pb{min-width:34px;height:34px;padding:0 .5rem;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-sm);font-size:.82rem;font-weight:500;border:1.5px solid var(--border);color:var(--text2);background:var(--surface);transition:all .15s}
.pb:hover{border-color:var(--primary);color:var(--primary)}
.pb.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.pb:disabled{opacity:.25;pointer-events:none}
.pi{font-size:.78rem;color:var(--text3);padding:0 .35rem}

/* MODAL */
.mo{position:fixed;inset:0;background:var(--modal-overlay);backdrop-filter:blur(5px);z-index:200;display:none;justify-content:flex-end}
.mo.on{display:flex}
.mp{width:500px;max-width:100vw;height:100vh;background:var(--modal-bg);overflow-y:auto;animation:slideIn .28s ease;box-shadow:-6px 0 30px rgba(0,0,0,.1);transition:background .3s}
.mclose{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:.55rem .85rem;background:rgba(255,255,255,.94);backdrop-filter:blur(10px);border-bottom:1px solid var(--border-light);transition:background .3s}
.mclose .mtitle{font-weight:600;font-size:.85rem;color:var(--text3)}
.mclose button{width:32px;height:32px;border-radius:50%;background:var(--surface2);display:flex;align-items:center;justify-content:center;transition:background .15s}
.mclose button:hover{background:var(--border)}
.mbody{padding:1.25rem}
.m-name{font-family:var(--font-display);font-size:1.35rem;font-weight:700;margin-bottom:.35rem;line-height:1.25}
.m-sec{margin-bottom:1.1rem}
.m-sec h4{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text3);margin-bottom:.4rem}
.m-row{display:flex;align-items:center;gap:.4rem;font-size:.85rem;color:var(--text2);margin-bottom:.3rem}
.m-row svg{width:15px;height:15px;color:var(--text3);flex-shrink:0}
.m-cta{display:flex;gap:.5rem;margin-top:1.25rem;flex-wrap:wrap}
.m-cta a{display:inline-flex;align-items:center;gap:.3rem;padding:.5rem 1rem;border-radius:var(--radius);font-size:.85rem;font-weight:500;transition:all .18s;text-decoration:none}
.btn-p{background:var(--primary);color:#fff}.btn-p:hover{background:var(--primary-dark)}
.btn-s{background:var(--surface);color:var(--text2);border:1.5px solid var(--border)}.btn-s:hover{border-color:var(--primary);color:var(--primary)}

/* Dropdowns */
.sdrop,.exp-drop{position:relative}
.smenu,.exp-menu{position:absolute;top:100%;right:0;margin-top:.3rem;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:.25rem;min-width:195px;z-index:50;display:none;max-height:calc(100vh - 120px);overflow-y:auto;-webkit-overflow-scrolling:touch}
.smenu.on,.exp-menu.on{display:block}
.sopt{padding:.4rem .65rem;border-radius:var(--radius-sm);font-size:.8rem;color:var(--text2);display:flex;align-items:center;gap:.3rem;width:100%;text-align:left;transition:background .1s}
.sopt:hover{background:var(--surface2)}.sopt.on{color:var(--primary);font-weight:600}
.exp-menu{min-width:180px}
.empty{text-align:center;padding:3.5rem 2rem;color:var(--text3)}
.empty .ei{font-size:2.5rem;margin-bottom:.5rem;display:block}

/* MOBILE */
.mfbtn{display:none!important}
@media(max-width:900px){
  .sidebar{position:fixed;left:0;top:0;height:100vh;height:100dvh;z-index:150;transform:translateX(-100%);box-shadow:var(--shadow-lg);overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:calc(1.5rem + env(safe-area-inset-bottom))}.sidebar.open{transform:translateX(0)}.mfbtn{display:inline-flex!important}.content{padding:.6rem .75rem}
}
@media(max-width:640px){
  .header-inner{gap:.35rem}.search-box{max-width:100%;order:10;min-width:100%}.hactions{width:100%;order:11;overflow-x:auto;flex-wrap:nowrap;gap:.25rem;scrollbar-width:none}.hactions::-webkit-scrollbar{display:none}.stats{padding:.35rem .75rem;font-size:.77rem}.mp{width:100%}.grid{gap:.65rem}
  .theme-toggle{flex-shrink:0}
  .card-photo{width:64px;height:64px;min-width:64px}
  .card-main-row{gap:.6rem;margin-bottom:.5rem}
  .card-footer{padding-top:.45rem}
  .btn-maps{font-size:.68rem;padding:.25rem .5rem}
}
</style>
</head>
<body>
<div id="splash">
  <div class="splash-logo">Z√ºriHub</div>
  <div class="splash-sub">Gastronomie-Datenbank Kanton Z√ºrich</div>
  <div class="splash-spinner" id="splashSpinner"></div>
  <div class="splash-msg" id="splashMsg">Datenbank wird geladen‚Ä¶</div>
  <div class="splash-bar" id="splashBarWrap"><div class="splash-bar-inner" id="pbar"></div></div>
  <div class="splash-upload" id="splashUpload">
    <div class="drop-zone" id="dropZone">
      <input type="file" accept=".json" id="fileInput">
      <span class="drop-icon">üìÇ</span>
      <div class="drop-text"><b>gastro.json</b> hierher ziehen<br>oder klicken zum Ausw√§hlen</div>
      <div class="drop-hint">Wird ben√∂tigt wenn nicht auf GitHub Pages gehostet</div>
    </div>
  </div>
</div>

<div id="app" style="display:none">
  <header class="header"><div class="header-inner">
    <a href="index.html" class="logo" onclick="localStorage.removeItem('zh-filter-state')"><svg class="logo-icon" width="28" height="28" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="92" height="92" rx="20" fill="currentColor" opacity=".08" stroke="currentColor" stroke-width="4"/><path d="M30 82V42l-4-2V38l12-14h2l2 5h16l2-5h2l12 14v2l-4 2v40" stroke="currentColor" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round"/><rect x="35" y="40" width="10" height="42" rx="1.5" stroke="currentColor" stroke-width="3.5"/><rect x="55" y="40" width="10" height="42" rx="1.5" stroke="currentColor" stroke-width="3.5"/><circle cx="40" cy="30" r="3.5" fill="currentColor"/><circle cx="60" cy="30" r="3.5" fill="currentColor"/><line x1="26" y1="82" x2="74" y2="82" stroke="currentColor" stroke-width="4" stroke-linecap="round"/><line x1="82" y1="12" x2="18" y2="88" stroke="#1a73e8" stroke-width="3" stroke-linecap="round" opacity=".18"/></svg>Z√ºriHub</a>
    <div class="search-box">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="si" placeholder="Name, Adresse, K√ºche, Keyword‚Ä¶" autocomplete="off">
    </div>
    <div class="hactions">
      <button class="hbtn mfbtn" onclick="toggleMF()"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Filter</button>
      <div class="vtog">
        <button class="on" onclick="setView('grid')" id="vGrid" title="Kacheln"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></button>
        <button onclick="setView('list')" id="vList" title="Liste"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3.5" cy="6" r="1" fill="currentColor"/><circle cx="3.5" cy="12" r="1" fill="currentColor"/><circle cx="3.5" cy="18" r="1" fill="currentColor"/></svg></button>
      </div>
      <div class="sdrop"><button class="hbtn" onclick="toggleSort(event)"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5h10M11 9h7M11 13h4M3 17l3 3 3-3M6 18V4"/></svg>Sortieren</button><div class="smenu" id="sortMenu"></div></div>
      <div class="exp-drop"><button class="hbtn" onclick="toggleExport(event)"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><div class="exp-menu" id="expMenu"><button class="sopt" onclick="doExportCSV()">üìÑ CSV herunterladen</button><button class="sopt" onclick="doExportPDF()">üìã PDF herunterladen</button></div></div>
      <a href="favoriten.html" class="hbtn" title="Favoriten" onclick="saveFilterState()">‚≠ê Favoriten</a>
      <div class="theme-toggle" onclick="toggleTheme()" title="Hell/Dunkel umschalten">
        <span class="toggle-icon-sun">‚òÄÔ∏è</span>
        <span class="toggle-icon-moon">üåô</span>
        <div class="toggle-knob"></div>
      </div>
    </div>
  </div></header>

  <div class="stats"><div class="rcnt" id="rcnt"></div><div class="chips" id="chips"></div></div>

  <div class="layout">
    <div class="fov" id="fov" onclick="toggleMF()"></div>
    <aside class="sidebar" id="sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem"><span style="font-weight:700;font-size:.9rem">Filter</span><button class="chip-clear" onclick="clearAll()">Zur√ºcksetzen</button></div>
      <div class="fs"><div class="fl">Betriebsart</div><div class="tg" id="fTrade"></div></div>
      <div class="fs" id="fCuisine"><div class="fl">K√ºche & Stil</div></div>
      <div class="fs"><div class="fl">Standort</div><div class="tg" style="gap:.35rem"><button id="btnStadtZh" class="tb" onclick="toggleStadtZh()" style="flex:1;justify-content:center;font-weight:600">üèôÔ∏è Stadt Z√ºrich</button><button id="btnWinti" class="tb" onclick="toggleWinti()" style="flex:1;justify-content:center;font-weight:600">üèôÔ∏è Winterthur</button></div></div>
      <div class="fs" id="fGeo"><div class="fl">Umkreis-Suche</div><div id="geoStatus"></div><div class="geo-input"><button class="btn-gps" id="gpsBtn" onclick="toggleGPS()" title="GPS-Standort verwenden"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/><circle cx="12" cy="12" r="8" stroke-dasharray="2 3"/></svg></button><input type="text" id="geoPlz" placeholder="PLZ" maxlength="4" inputmode="numeric" pattern="[0-9]*"></div><div class="geo-hint" id="geoHint">PLZ eingeben oder GPS nutzen, dann Radius w√§hlen</div><div class="tg" id="geoRadius"></div></div>
      <div class="fs"><div class="fl">Bewertung</div><div class="rng"><label>Mindestbewertung <b id="ratingVal">1.0</b></label><input type="range" min="1" max="5" step="0.1" value="1" id="ratingSlider" oninput="onRating(this.value)"></div><div class="rng" style="margin-top:.5rem"><label>Min. Bewertungen <b id="revVal">40</b></label><input type="range" min="0" max="100" value="0" id="revSlider" oninput="onRevCount(this.value)"></div><div class="rpre" id="revPresets"></div></div>
    </aside>
    <main class="content">
      <div class="grid" id="grid"></div>
      <div class="lview" id="lview"><table class="ltbl"><thead id="lhead"></thead><tbody id="lbody"></tbody></table></div>
      <div class="empty" id="empty" style="display:none"><span class="ei">üîç</span><h3 style="font-size:1rem;margin-bottom:.3rem">Keine Ergebnisse</h3><p style="font-size:.85rem">Versuche andere Filter oder Suchbegriffe.</p></div>
      <div class="pag" id="pag"></div>
    </main>
  </div>
</div>

<div class="mo" id="modal" onclick="if(event.target===this)closeModal()"><div class="mp">
  <div class="mclose"><span class="mtitle">Details</span><button onclick="closeModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
  <div class="mbody" id="mbody"></div>
</div></div>

<!-- Back to top -->
<button class="btt" id="btt" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="Nach oben">‚Üë</button>

<script>
// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
(function(){var t=localStorage.getItem('zh-theme');if(t==='dark')document.documentElement.classList.add('dark')})();
function toggleTheme(){document.documentElement.classList.toggle('dark');localStorage.setItem('zh-theme',document.documentElement.classList.contains('dark')?'dark':'light')}

// ‚îÄ‚îÄ FAVORITES ‚îÄ‚îÄ
function getFavs(){try{return JSON.parse(localStorage.getItem('zh-favs'))||[]}catch(e){return[]}}
function saveFavs(arr){localStorage.setItem('zh-favs',JSON.stringify(arr))}
function isFav(id){return getFavs().indexOf(id)>=0}
function toggleFav(id,e){
  if(e){e.stopPropagation();e.preventDefault()}
  var favs=getFavs();var idx=favs.indexOf(id);
  if(idx>=0)favs.splice(idx,1);else favs.push(id);
  saveFavs(favs);
  document.querySelectorAll('.fav-star[data-id="'+id+'"]').forEach(function(s){s.classList.toggle('active',favs.indexOf(id)>=0);s.textContent=favs.indexOf(id)>=0?'‚òÖ':'‚òÜ'});
}

// ‚îÄ‚îÄ FILTER STATE PERSISTENCE ‚îÄ‚îÄ
function saveFilterState(){
  var state={s:fl.s,tr:Array.from(fl.tr),cu:Array.from(fl.cu),ci:Array.from(fl.ci),mr:fl.mr,mv:fl.mv,stadtZh:fl.stadtZh,winterthur:fl.winterthur,sortK:sort.k,sortD:sort.d,page:page};
  localStorage.setItem('zh-filter-state',JSON.stringify(state));
}
function restoreFilterState(){
  try{
    var raw=localStorage.getItem('zh-filter-state');if(!raw)return false;
    var st=JSON.parse(raw);
    fl.s=st.s||'';fl.tr=new Set(st.tr||[]);fl.cu=new Set(st.cu||[]);fl.ci=new Set(st.ci||[]);
    fl.mr=st.mr||1;fl.mv=st.mv||40;fl.stadtZh=!!st.stadtZh;fl.winterthur=!!st.winterthur;
    sort={k:st.sortK||'reviewCount',d:st.sortD||'desc'};page=st.page||1;
    if(fl.s)document.getElementById('si').value=fl.s;
    document.getElementById('ratingSlider').value=fl.mr;document.getElementById('ratingVal').textContent=fl.mr.toFixed(1);
    var rvSlider=rv2s(fl.mv);document.getElementById('revSlider').value=rvSlider;document.getElementById('revVal').textContent=fl.mv>=14000?'14000+':''+fl.mv;
    fl.tr.forEach(function(t){var b=document.querySelector('[data-k="tr"][data-v="'+t+'"]');if(b)b.classList.add('on')});
    fl.cu.forEach(function(c){var b=document.querySelector('[data-k="cu"][data-v="'+c+'"]');if(b)b.classList.add('on')});
    if(fl.stadtZh)document.getElementById('btnStadtZh').classList.add('on');
    if(fl.winterthur)document.getElementById('btnWinti').classList.add('on');
    buildSortMenu();return true;
  }catch(e){return false}
}

// ‚îÄ‚îÄ BACK TO TOP ‚îÄ‚îÄ
window.addEventListener('scroll',function(){var b=document.getElementById('btt');if(b)b.classList.toggle('show',window.scrollY>300)},{passive:true});

let ALL=[],FLT=[],page=1;const PER=48;let view='grid';let sort={k:'reviewCount',d:'desc'};
let fl={s:'',tr:new Set(),cu:new Set(),ci:new Set(),mr:1.0,mv:40,stadtZh:false,winterthur:false};
let idxCity={},idxType={},idxTrade={},idxCuisine={};

// ‚îÄ‚îÄ GPS state ‚îÄ‚îÄ
var gpsActive=false, gpsLat=null, gpsLng=null;

const CMAP={
  vegan_restaurant:{l:'Vegan',i:'üå±',cat:'diet'},vegetarian_restaurant:{l:'Vegetarisch',i:'ü•ó',cat:'diet'},
  steak_house:{l:'Steakhouse',i:'ü•©',cat:'meat'},barbecue_restaurant:{l:'BBQ / Grill',i:'üî•',cat:'meat'},
  pizza_restaurant:{l:'Pizzeria',i:'üçï',cat:'dish'},sushi_restaurant:{l:'Sushi',i:'üç£',cat:'dish'},
  hamburger_restaurant:{l:'Burger',i:'üçî',cat:'dish'},kebab_shop:{l:'D√∂ner / Kebab',i:'ü•ô',cat:'dish'},
  fast_food_restaurant:{l:'Fast Food',i:'üçü',cat:'dish'},seafood_restaurant:{l:'Seafood',i:'ü¶ê',cat:'dish'},
  breakfast_restaurant:{l:'Fr√ºhst√ºck',i:'ü•û',cat:'dish'},brunch_restaurant:{l:'Brunch',i:'üç≥',cat:'dish'},
  bistro:{l:'Bistro',i:'üç¥',cat:'dish'},buffet_restaurant:{l:'Buffet',i:'üç±',cat:'dish'},
  ramen_restaurant:{l:'Ramen',i:'üçú',cat:'dish'},sandwich_shop:{l:'Sandwich',i:'ü•™',cat:'dish'},
  fusion_restaurant:{l:'Fusion',i:'‚ú®',cat:'dish'},family_restaurant:{l:'Familienrest.',i:'üë®‚Äçüë©‚Äçüëß',cat:'dish'},
  swiss_restaurant:{l:'Schweizer',i:'üá®üá≠',cat:'origin'},italian_restaurant:{l:'Italienisch',i:'üáÆüáπ',cat:'origin'},
  turkish_restaurant:{l:'T√ºrkisch',i:'üáπüá∑',cat:'origin'},greek_restaurant:{l:'Griechisch',i:'üá¨üá∑',cat:'origin'},
  indian_restaurant:{l:'Indisch',i:'üáÆüá≥',cat:'origin'},thai_restaurant:{l:'Thai',i:'üáπüá≠',cat:'origin'},
  japanese_restaurant:{l:'Japanisch',i:'üáØüáµ',cat:'origin'},chinese_restaurant:{l:'Chinesisch',i:'üá®üá≥',cat:'origin'},
  vietnamese_restaurant:{l:'Vietnamesisch',i:'üáªüá≥',cat:'origin'},korean_restaurant:{l:'Koreanisch',i:'üá∞üá∑',cat:'origin'},
  mexican_restaurant:{l:'Mexikanisch',i:'üá≤üáΩ',cat:'origin'},lebanese_restaurant:{l:'Libanesisch',i:'üá±üáß',cat:'origin'},
  american_restaurant:{l:'Amerikanisch',i:'üá∫üá∏',cat:'origin'},french_restaurant:{l:'Franz√∂sisch',i:'üá´üá∑',cat:'origin'},
  spanish_restaurant:{l:'Spanisch',i:'üá™üá∏',cat:'origin'},mediterranean_restaurant:{l:'Mediterran',i:'ü´í',cat:'origin'},
  middle_eastern_restaurant:{l:'Nah√∂stlich',i:'üßÜ',cat:'origin'},asian_restaurant:{l:'Asiatisch',i:'ü•¢',cat:'origin'},
  european_restaurant:{l:'Europ√§isch',i:'üçΩÔ∏è',cat:'origin'},african_restaurant:{l:'Afrikanisch',i:'üåç',cat:'origin'},
  indonesian_restaurant:{l:'Indonesisch',i:'üáÆüá©',cat:'origin'},persian_restaurant:{l:'Persisch',i:'üáÆüá∑',cat:'origin'},
  cocktail_bar:{l:'Cocktailbar',i:'üç∏',cat:'drinks'},wine_bar:{l:'Weinbar',i:'üç∑',cat:'drinks'},
  pub:{l:'Pub',i:'üç∫',cat:'drinks'},hookah_bar:{l:'Shisha Bar',i:'üí®',cat:'drinks'},
  lounge_bar:{l:'Lounge',i:'üõãÔ∏è',cat:'drinks'},night_club:{l:'Nachtclub',i:'üéµ',cat:'drinks'},
  beer_garden:{l:'Biergarten',i:'üçª',cat:'drinks'},sports_bar:{l:'Sports Bar',i:'‚öΩ',cat:'drinks'},
  brewery:{l:'Brauerei',i:'üè≠',cat:'drinks'},
  confectionery:{l:'Konditorei',i:'üç∞',cat:'sweet'},pastry_shop:{l:'Patisserie',i:'ü•ê',cat:'sweet'},
  ice_cream_shop:{l:'Eisdiele',i:'üç¶',cat:'sweet'},dessert_shop:{l:'Desserts',i:'üßÅ',cat:'sweet'},
  chocolate_shop:{l:'Schokolade',i:'üç´',cat:'sweet'},
  coffee_shop:{l:'Coffee Shop',i:'‚òï',cat:'service'},meal_takeaway:{l:'Takeaway',i:'ü•°',cat:'service'},
  meal_delivery:{l:'Lieferdienst',i:'üö¥',cat:'service'},food_delivery:{l:'Lieferung',i:'üì¶',cat:'service'},
  catering_service:{l:'Catering',i:'üé™',cat:'service'},pizza_delivery:{l:'Pizza-Lief.',i:'üõµ',cat:'service'},
  snack_bar:{l:'Snack Bar',i:'üçø',cat:'service'},
};
const CAT_LABELS={diet:'Ern√§hrungsweise',meat:'Fleisch & Grill',dish:'Gerichte & Stil',origin:'Herkunft / K√ºche',drinks:'Getr√§nke & Nightlife',sweet:'S√ºsses & Geb√§ck',service:'Service & Typ'};
const CAT_ORDER=['diet','meat','dish','origin','drinks','sweet'];
const TRADE_I={'Restaurant':'üçΩÔ∏è','Bar':'üç∫','Caf√©':'‚òï','Hotel':'üè®','B√§ckerei':'ü•ê','Takeaway':'ü•°','Einkaufszentrum':'üè¨'};
const KREIS={8001:1,8002:2,8003:3,8004:4,8005:5,8006:6,8008:8,8032:7,8037:10,8038:2,8040:4,8041:7,8044:7,8045:3,8046:6,8047:5,8048:4,8049:10,8050:11,8051:11,8052:12,8053:7,8055:3,8057:6,8058:12,8060:11,8064:9,8092:1};

// PLZ‚Üí[lat,lng] built from dataset
var PLZ_GEO={};
function buildPlzGeo(){
  var acc={};
  ALL.forEach(function(p){
    if(!p.lat||!p.lng)return;
    var m=(p.addr||'').match(/\b(\d{4})\b/);if(!m)return;var plz=m[1];
    if(!acc[plz])acc[plz]={la:0,lo:0,n:0};
    acc[plz].la+=p.lat;acc[plz].lo+=p.lng;acc[plz].n++;
  });
  Object.keys(acc).forEach(function(k){var a=acc[k];PLZ_GEO[k]=[Math.round(a.la/a.n*100000)/100000,Math.round(a.lo/a.n*100000)/100000]});
}
function haversine(lat1,lon1,lat2,lon2){
  var R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
  var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
var geoOrigin=null,geoRadius=0;

// ‚îÄ‚îÄ STADT Z√úRICH / WINTERTHUR FILTER ‚îÄ‚îÄ
function isStadtZuerich(addr){var m=(addr||'').match(/\b(80\d{2})\b/);return m!==null}
function isWinterthur(city){return(city||'').toLowerCase()==='winterthur'}
function toggleStadtZh(){fl.stadtZh=!fl.stadtZh;document.getElementById('btnStadtZh').classList.toggle('on',fl.stadtZh);page=1;apply()}
function toggleWinti(){fl.winterthur=!fl.winterthur;document.getElementById('btnWinti').classList.toggle('on',fl.winterthur);page=1;apply()}

// ‚îÄ‚îÄ POSITION DROPDOWN (mobile fix) ‚îÄ‚îÄ
function positionDropdown(btnEl,menuEl){var rect=btnEl.getBoundingClientRect();menuEl.style.position='fixed';menuEl.style.top=(rect.bottom+4)+'px';var rightEdge=window.innerWidth-rect.right;menuEl.style.right=Math.max(4,rightEdge)+'px';menuEl.style.left='auto';menuEl.style.maxWidth=(window.innerWidth-8)+'px'}

// ‚îÄ‚îÄ OPEN MAPS (native app on mobile) ‚îÄ‚îÄ
function openMaps(url,lat,lng,name){var ua=navigator.userAgent;var isMobile=/iPhone|iPad|iPod|Android/i.test(ua);if(!isMobile){window.open(url,'_blank','noopener');return}var isIOS=/iPhone|iPad|iPod/i.test(ua);var isAndroid=/Android/i.test(ua);if(lat&&lng){if(isIOS){var gmapsApp='comgooglemaps://?q='+encodeURIComponent(name)+'&center='+lat+','+lng;var appleMaps='https://maps.apple.com/?q='+encodeURIComponent(name)+'&ll='+lat+','+lng;var fallback=setTimeout(function(){window.location.href=appleMaps},1200);window.addEventListener('blur',function cancel(){clearTimeout(fallback);window.removeEventListener('blur',cancel)},{once:true});window.location.href=gmapsApp}else if(isAndroid){window.location.href='geo:'+lat+','+lng+'?q='+encodeURIComponent(name)}else{window.open(url,'_blank','noopener')}}else{window.open(url,'_blank','noopener')}}

// ‚îÄ‚îÄ SYNC SIDEBAR TOP ‚îÄ‚îÄ
function syncSidebarTop(){var header=document.querySelector('.header');var stats=document.querySelector('.stats');if(!header||!stats)return;var h=header.offsetHeight+stats.offsetHeight;var sidebar=document.getElementById('sidebar');if(sidebar){sidebar.style.top=h+'px';sidebar.style.maxHeight='calc(100vh - '+h+'px)'}}
window.addEventListener('resize',syncSidebarTop);

// ‚îÄ‚îÄ CLOSE DROPDOWNS ON SCROLL ‚îÄ‚îÄ
window.addEventListener('scroll',function(){document.getElementById('sortMenu').classList.remove('on');document.getElementById('expMenu').classList.remove('on')},{passive:true});

function getKreis(a){if(!a)return 0;const m=a.match(/\b(80\d{2})\b/);return m?KREIS[+m[1]]||0:0}
function kreisTag(a){const k=getKreis(a);return k?'<span class="kreis">K'+k+'</span>':''}
function xCity(a){if(!a)return'';const p=a.split(',');if(p.length<2)return a.trim();const l=p[p.length-1].trim(),t=l.split(/\s+/);return t.length>=2&&/^\d{4,5}$/.test(t[0])?t.slice(1).join(' '):l}
function stars(r,sz){sz=sz||13;let h='',fu=Math.floor(r),ha=r-fu>=.25;for(let i=0;i<5;i++){if(i<fu)h+='<svg width="'+sz+'" height="'+sz+'" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';else if(i===fu&&ha)h+='<svg width="'+sz+'" height="'+sz+'" viewBox="0 0 24 24"><defs><linearGradient id="hg'+sz+'"><stop offset="50%" stop-color="currentColor"/><stop offset="50%" stop-color="#D4DCE8"/></linearGradient></defs><path fill="url(#hg'+sz+')" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';else h+='<svg class="e" width="'+sz+'" height="'+sz+'" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'}return h}
function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function debounce(fn,ms){var t;return function(){var a=arguments;clearTimeout(t);t=setTimeout(function(){fn.apply(null,a)},ms)}}
function fmt(n){return n.toLocaleString('de-CH')}
function s2rv(v){v=+v;if(!v)return 40;return Math.round(40+Math.pow(v/100,2)*14653)}
function rv2s(r){if(r<=40)return 0;return Math.round(Math.sqrt((r-40)/14653)*100)}

// ‚îÄ‚îÄ SVG Placeholder Photo ‚îÄ‚îÄ
var PLACEHOLDER_PHOTO="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23F5F0EB' rx='12'/%3E%3Ctext x='40' y='44' text-anchor='middle' dominant-baseline='middle' font-family='system-ui,sans-serif' font-size='10' font-weight='500' fill='%238A8078'%3ETest Foto%3C/text%3E%3C/svg%3E";

function getCardPhoto(p){
  return p.photo_url||PLACEHOLDER_PHOTO;
}

function getMapsUrl(p){
  if(p.gmaps)return p.gmaps;
  if(p.id&&p.id.startsWith('ChI'))return 'https://www.google.com/maps/place/?q=place_id:'+p.id;
  return 'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent((p.name||'')+' '+(p.addr||''));
}

// ‚îÄ‚îÄ GPS FUNCTIONS ‚îÄ‚îÄ
function toggleGPS(){
  if(gpsActive){deactivateGPS();return}
  activateGPS();
}
function activateGPS(){
  var btn=document.getElementById('gpsBtn');
  if(!navigator.geolocation){
    showGeoHint('GPS nicht verf√ºgbar auf diesem Ger√§t.');
    return;
  }
  btn.classList.add('loading');
  navigator.geolocation.getCurrentPosition(
    function(pos){
      btn.classList.remove('loading');
      btn.classList.add('active');
      gpsLat=pos.coords.latitude;
      gpsLng=pos.coords.longitude;
      gpsActive=true;
      document.getElementById('geoPlz').value='';
      document.getElementById('geoPlz').classList.remove('ok','err');
      geoOrigin={lat:gpsLat,lng:gpsLng,plz:'GPS'};
      showGeoHint('üìç GPS-Standort aktiv');
      if(geoRadius>0){page=1;apply();updGeoStatus()}
      else{updGeoStatus()}
    },
    function(err){
      btn.classList.remove('loading');
      showGeoHint('Standort konnte nicht ermittelt werden.');
    },
    {enableHighAccuracy:true,timeout:8000}
  );
}
function deactivateGPS(){
  gpsActive=false;gpsLat=null;gpsLng=null;
  document.getElementById('gpsBtn').classList.remove('active');
  geoOrigin=null;
  showGeoHint('PLZ eingeben oder GPS nutzen, dann Radius w√§hlen');
  updGeoStatus();
  if(geoRadius>0){page=1;apply()}
}
function showGeoHint(msg){
  document.getElementById('geoHint').textContent=msg;
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
async function init(){
  var bar=document.getElementById('pbar'),msg=document.getElementById('splashMsg');
  try{
    bar.style.width='15%';
    var resp=await fetch('gastro.json');
    if(!resp.ok)throw new Error('FETCH_FAIL');
    bar.style.width='40%';msg.textContent='JSON wird geparst‚Ä¶';
    var raw=await resp.json();
    processAndBoot(raw);
  }catch(err){
    if(err.message==='FETCH_FAIL'||err instanceof TypeError){
      msg.textContent='Bitte gastro.json manuell laden:';msg.style.opacity='1';
      document.getElementById('splashBarWrap').style.display='none';
      document.getElementById('splashSpinner').style.display='none';
      document.getElementById('splashUpload').classList.add('show');
      setupUpload();
    }else{msg.textContent='Fehler: '+err.message;msg.style.color='#FF6B6B';console.error(err)}
  }
}
function setupUpload(){
  var z=document.getElementById('dropZone'),inp=document.getElementById('fileInput');
  z.ondragover=function(e){e.preventDefault();z.classList.add('over')};
  z.ondragleave=function(){z.classList.remove('over')};
  z.ondrop=function(e){e.preventDefault();z.classList.remove('over');if(e.dataTransfer.files[0])readFile(e.dataTransfer.files[0])};
  inp.onchange=function(e){if(e.target.files[0])readFile(e.target.files[0])};
}
function readFile(file){
  var msg=document.getElementById('splashMsg'),bar=document.getElementById('pbar');
  msg.textContent='Datei wird gelesen‚Ä¶';msg.style.opacity='.6';
  document.getElementById('splashUpload').classList.remove('show');
  document.getElementById('splashSpinner').style.display='';
  document.getElementById('splashBarWrap').style.display='';bar.style.width='30%';
  var reader=new FileReader();
  reader.onload=function(e){try{processAndBoot(JSON.parse(e.target.result))}catch(err){msg.textContent='JSON Fehler: '+err.message;msg.style.color='#FF6B6B'}};
  reader.readAsText(file);
}
async function processAndBoot(raw){
  var bar=document.getElementById('pbar'),msg=document.getElementById('splashMsg');
  try{
    var places=Array.isArray(raw)?raw:(raw.places||raw.results||[]);
    bar.style.width='60%';msg.textContent=fmt(places.length)+' Eintr√§ge werden verarbeitet‚Ä¶';
    await new Promise(function(r){setTimeout(r,30)});
    var SKIP=new Set(['point_of_interest','establishment','food','store','service','food_store']);
    ALL=places.map(function(p){
      var city=xCity(p.address||p.formatted_address||p.vicinity||'');
      var types=(p.types||[]).filter(function(t){return !SKIP.has(t)});
      var cuisines=types.filter(function(t){return !!CMAP[t]});
      var trade=p.trade||'';
      if(types.indexOf('shopping_mall')>=0||types.indexOf('department_store')>=0)trade='Einkaufszentrum';
      var st=[p.name,p.address,trade].concat(types).concat(cuisines.map(function(c){return(CMAP[c]||{}).l||''})).join(' ').toLowerCase();
      return{id:p.id||p.place_id||'',name:p.name||'',addr:p.address||p.formatted_address||p.vicinity||'',lat:p.lat||0,lng:p.lng||0,r:p.rating||0,rv:p.reviewCount||p.user_ratings_total||0,gmaps:p.gmapsUrl||'',web:p.website||'',ph:p.phone||'',pc:p.photoCount!=null?p.photoCount:(p.photos?p.photos.length:0),trade:trade,types:types,cuisines:cuisines,city:city,searchText:st,photo_url:p.photo_url||''};
    });
    bar.style.width='75%';msg.textContent='Indizes werden aufgebaut‚Ä¶';
    await new Promise(function(r){setTimeout(r,20)});
    ALL.forEach(function(p){
      if(p.city)idxCity[p.city]=(idxCity[p.city]||0)+1;
      if(p.trade)idxTrade[p.trade]=(idxTrade[p.trade]||0)+1;
      p.cuisines.forEach(function(c){idxCuisine[c]=(idxCuisine[c]||0)+1});
    });
    bar.style.width='90%';msg.textContent='Interface wird aufgebaut‚Ä¶';
    await new Promise(function(r){setTimeout(r,20)});
    buildPlzGeo();buildUI();FLT=ALL.slice();
    var restored=restoreFilterState();localStorage.removeItem('zh-filter-state');
    if(restored){apply()}else{sortFLT();render();updCount();updChips()}
    bar.style.width='100%';
    await new Promise(function(r){setTimeout(r,250)});
    document.getElementById('splash').classList.add('done');document.getElementById('app').style.display='';
    setTimeout(function(){var s=document.getElementById('splash');if(s)s.remove()},600);
  }catch(err){msg.textContent='Fehler: '+err.message;msg.style.color='#FF6B6B';console.error(err)}
}

function buildUI(){
  // ‚îÄ‚îÄ Betriebsart ‚îÄ‚îÄ
  var te=document.getElementById('fTrade');
  Object.entries(idxTrade).sort(function(a,b){return b[1]-a[1]}).forEach(function(e){
    var b=mk('button','tb');b.dataset.k='tr';b.dataset.v=e[0];
    b.innerHTML=(TRADE_I[e[0]]||'üìç')+' '+e[0]+'<span class="n">'+e[1]+'</span>';
    b.onclick=function(){togF('tr',e[0],b)};te.appendChild(b);
  });

  // ‚îÄ‚îÄ Cuisine filters as accordion sections with 2-col grid ‚îÄ‚îÄ
  var cf=document.getElementById('fCuisine'),byCat={};
  Object.entries(idxCuisine).forEach(function(e){var info=CMAP[e[0]];if(!info)return;if(!byCat[info.cat])byCat[info.cat]=[];byCat[info.cat].push({k:e[0],n:e[1],l:info.l,i:info.i})});
  CAT_ORDER.forEach(function(cat){
    var items=byCat[cat];if(!items||!items.length)return;items.sort(function(a,b){return b.n-a.n});
    // Accordion label
    var lbl=document.createElement('button');
    lbl.className='filter-section-label';
    lbl.textContent=CAT_LABELS[cat];
    lbl.addEventListener('click',function(){
      lbl.classList.toggle('open');
      body.classList.toggle('open');
    });
    cf.appendChild(lbl);
    // Body with 2-col grid
    var body=document.createElement('div');
    body.className='filter-section-body';
    var grid=document.createElement('div');
    grid.className='filter-chips-grid';
    items.forEach(function(it){
      var b=document.createElement('button');
      b.className='filter-chip';
      b.dataset.k='cu';b.dataset.v=it.k;
      b.innerHTML=it.i+' '+it.l+'<span class="chip-count">'+it.n+'</span>';
      b.onclick=function(){togF('cu',it.k,b)};
      grid.appendChild(b);
    });
    body.appendChild(grid);
    cf.appendChild(body);
  });

  // ‚îÄ‚îÄ Review presets ‚îÄ‚îÄ
  var rp=document.getElementById('revPresets');
  [50,100,200,500,1000].forEach(function(v){var b=mk('button','tb');b.textContent=v+'+';b.onclick=function(){var sl=document.getElementById('revSlider');sl.value=rv2s(v);onRevCount(sl.value)};rp.appendChild(b)});

  // ‚îÄ‚îÄ Geo radius buttons ‚îÄ‚îÄ
  var gr=document.getElementById('geoRadius');
  [1,2,3,5,7,10,15].forEach(function(km){
    var b=mk('button','tb');b.dataset.km=km;b.textContent=km+' km';
    b.onclick=function(){setGeoRadius(km)};gr.appendChild(b);
  });
  document.getElementById('geoPlz').oninput=function(){
    // Deactivate GPS when user types PLZ
    if(gpsActive)deactivateGPS();
    onGeoPlz(this.value);
  };
  buildSortMenu();
  document.getElementById('si').oninput=debounce(function(){fl.s=document.getElementById('si').value.toLowerCase().trim();page=1;apply()},300);
  syncSidebarTop();
}
function mk(tag,cls){var e=document.createElement(tag);e.className=cls;return e}
function togF(set,val,btn){
  if(fl[set].has(val)){fl[set].delete(val);if(btn)btn.classList.remove('on')}
  else{fl[set].add(val);if(btn)btn.classList.add('on')}
  page=1;apply();
}
function onRating(v){document.getElementById('ratingVal').textContent=(+v).toFixed(1);fl.mr=+v;page=1;apply()}
function onRevCount(v){var r=s2rv(v);document.getElementById('revVal').textContent=r>=14000?'14000+':''+r;fl.mv=r;page=1;apply()}
function clearAll(){
  fl={s:'',tr:new Set(),cu:new Set(),ci:new Set(),mr:1.0,mv:40,stadtZh:false,winterthur:false};
  document.getElementById('si').value='';
  document.getElementById('ratingSlider').value=1;document.getElementById('ratingVal').textContent='1.0';
  document.getElementById('revSlider').value=0;document.getElementById('revVal').textContent='40';
  document.querySelectorAll('.tb.on,.filter-chip.on').forEach(function(b){b.classList.remove('on')});
  document.getElementById('btnStadtZh').classList.remove('on');
  document.getElementById('btnWinti').classList.remove('on');
  if(gpsActive)deactivateGPS();
  clearGeo();
  page=1;apply();
}
// ‚îÄ‚îÄ GEO FILTER ‚îÄ‚îÄ
function onGeoPlz(val){
  var inp=document.getElementById('geoPlz');
  val=val.replace(/\D/g,'');inp.value=val;
  inp.classList.remove('ok','err');
  if(val.length===4){
    if(PLZ_GEO[val]){
      inp.classList.add('ok');
      geoOrigin={lat:PLZ_GEO[val][0],lng:PLZ_GEO[val][1],plz:val};
      if(geoRadius>0){page=1;apply()}
      updGeoStatus();
    }else{inp.classList.add('err');geoOrigin=null;if(geoRadius>0){page=1;apply()}updGeoStatus()}
  }else{geoOrigin=null;if(geoRadius>0){page=1;apply()}updGeoStatus()}
}
function setGeoRadius(km){
  document.querySelectorAll('#geoRadius .tb').forEach(function(b){b.classList.toggle('on',+b.dataset.km===km)});
  geoRadius=(geoRadius===km)?0:km;
  if(geoRadius===0){document.querySelectorAll('#geoRadius .tb').forEach(function(b){b.classList.remove('on')});if(sort.k==='distance')sort={k:'reviewCount',d:'desc'}}
  else if(geoOrigin){sort={k:'distance',d:'asc'}}
  buildSortMenu();
  page=1;apply();updGeoStatus();
}
function clearGeo(){
  geoOrigin=null;geoRadius=0;
  document.getElementById('geoPlz').value='';
  document.getElementById('geoPlz').classList.remove('ok','err');
  document.querySelectorAll('#geoRadius .tb').forEach(function(b){b.classList.remove('on')});
  updGeoStatus();page=1;apply();
}
function updGeoStatus(){
  var el=document.getElementById('geoStatus');
  var label=gpsActive?'GPS':geoOrigin?'PLZ '+geoOrigin.plz:'';
  if(geoOrigin&&geoRadius>0){
    el.innerHTML='<div class="geo-active">üìç '+label+' ¬∑ '+geoRadius+' km<button onclick="clearGeo();if(gpsActive)deactivateGPS()">‚úï Reset</button></div>';
  }else{el.innerHTML=''}
}
function getDist(p){
  if(!geoOrigin||!p.lat||!p.lng)return -1;
  return haversine(geoOrigin.lat,geoOrigin.lng,p.lat,p.lng);
}
function distTag(p){
  var d=p._dist;if(d==null||d<0)return'';
  var txt=d<1?(Math.round(d*1000)+'m'):d.toFixed(1)+' km';
  return '<span class="dist"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>'+txt+'</span>';
}
function apply(){
  FLT=ALL.filter(function(p){
    if(fl.s&&p.searchText.indexOf(fl.s)<0)return false;
    if(fl.tr.size&&!fl.tr.has(p.trade))return false;
    if(fl.cu.size&&!p.cuisines.some(function(c){return fl.cu.has(c)}))return false;
    if(fl.stadtZh||fl.winterthur){if(!((fl.stadtZh&&isStadtZuerich(p.addr))||(fl.winterthur&&isWinterthur(p.city))))return false}
    if(p.r<fl.mr)return false;
    if(p.rv<fl.mv)return false;
    return true;
  });
  var hasGeo=geoOrigin&&geoRadius>0;
  FLT.forEach(function(p){p._dist=geoOrigin?getDist(p):-1});
  if(hasGeo){FLT=FLT.filter(function(p){return p._dist>=0&&p._dist<=geoRadius})}
  sortFLT();render();updChips();updCount();
}
function sortFLT(){
  var k=sort.k,m=sort.d==='asc'?1:-1;
  FLT.sort(function(a,b){
    if(k==='distance'){var da=a._dist>=0?a._dist:99999,db=b._dist>=0?b._dist:99999;return(da-db)*m}
    if(k==='rating')return(a.r-b.r)*m;
    if(k==='reviewCount')return(a.rv-b.rv)*m;
    if(k==='name'){var x=a.name.toLowerCase(),y=b.name.toLowerCase();return x<y?-m:x>y?m:0}
    return(a.rv-b.rv)*m;
  });
}
function buildSortMenu(){
  var opts=[{k:'reviewCount',d:'desc',l:'Meiste Bewertungen'},{k:'reviewCount',d:'asc',l:'Wenigste Bewertungen'},{k:'rating',d:'desc',l:'Beste Bewertung'},{k:'rating',d:'asc',l:'Schlechteste Bewertung'},{k:'name',d:'asc',l:'Name A ‚Üí Z'},{k:'name',d:'desc',l:'Name Z ‚Üí A'}];
  if(geoOrigin&&geoRadius>0)opts.unshift({k:'distance',d:'asc',l:'üìç N√§chste zuerst'},{k:'distance',d:'desc',l:'üìç Weiteste zuerst'});
  document.getElementById('sortMenu').innerHTML=opts.map(function(o){return '<button class="sopt '+(o.k===sort.k&&o.d===sort.d?'on':'')+'" onclick="setSort(\''+o.k+"','"+o.d+"')\">"+o.l+'</button>'}).join('');
}
function setSort(k,d){sort={k:k,d:d};document.getElementById('sortMenu').classList.remove('on');buildSortMenu();page=1;apply()}
function toggleSort(e){if(e)e.stopPropagation();var menu=document.getElementById('sortMenu');var wasOpen=menu.classList.contains('on');document.getElementById('sortMenu').classList.remove('on');document.getElementById('expMenu').classList.remove('on');if(!wasOpen){positionDropdown(e.currentTarget,menu);menu.classList.add('on')}}
function toggleExport(e){if(e)e.stopPropagation();var menu=document.getElementById('expMenu');var wasOpen=menu.classList.contains('on');document.getElementById('sortMenu').classList.remove('on');document.getElementById('expMenu').classList.remove('on');if(!wasOpen){positionDropdown(e.currentTarget,menu);menu.classList.add('on')}}
document.addEventListener('click',function(e){if(!e.target.closest('.sdrop'))document.getElementById('sortMenu').classList.remove('on');if(!e.target.closest('.exp-drop'))document.getElementById('expMenu').classList.remove('on')});

function render(){if(view==='grid')renderGrid();else renderList();renderPag()}

function cardIcon(p){
  var t=(p.trade||'default').toLowerCase().replace(/\s+/g,'-');
  var cls='ci-'+({'restaurant':1,'bar':1,'caf√©':1,'hotel':1,'b√§ckerei':1,'takeaway':1,'einkaufszentrum':1}[t]?t:'default');
  var icon=TRADE_I[p.trade]||'üçΩÔ∏è';
  if(p.cuisines.length>0){var cm=CMAP[p.cuisines[0]];if(cm)icon=cm.i}
  return '<div class="card-icon '+cls+'">'+icon+'</div>';
}

function renderGrid(){
  var g=document.getElementById('grid'),l=document.getElementById('lview'),em=document.getElementById('empty');
  g.style.display='grid';l.style.display='none';
  if(!FLT.length){g.style.display='none';em.style.display='';return}em.style.display='none';
  var start=(page-1)*PER,slice=FLT.slice(start,start+PER);
  var favs=getFavs();
  g.innerHTML=slice.map(function(p,i){
    var globalRank=start+i+1;
    var cu=p.cuisines.slice(0,2).map(function(c){return '<span class="tag">'+CMAP[c].i+' '+CMAP[c].l+'</span>'}).join('');
    var kr=kreisTag(p.addr);
    var dt=distTag(p);
    var photoSrc=getCardPhoto(p);
    var mapsUrl=getMapsUrl(p);
    var faved=favs.indexOf(p.id)>=0;
    var rankCls=globalRank<=3?'rank-badge top3':'rank-badge';
    return '<div class="card fade-up" style="animation-delay:'+Math.min(i*20,200)+'ms" onclick="openModal(\''+p.id+'\')">'
      +'<div class="card-header">'
        +'<div class="'+rankCls+'"># '+globalRank+'</div>'
        +(p.trade?'<div class="card-trade">'+(TRADE_I[p.trade]||'üìç')+' '+p.trade+'</div>':'')
      +'</div>'
      +'<div class="card-main-row">'
        +'<img class="card-photo" src="'+photoSrc+'" alt="" loading="lazy">'
        +'<div class="card-content">'
          +'<div class="card-name">'+esc(p.name)+'</div>'
          +'<div class="card-addr"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg><span class="card-addr-text">'+esc(p.addr)+'</span>'+kr+dt+'</div>'
          +'<div class="card-rating"><div class="stars">'+stars(p.r)+'</div><span class="card-score">'+p.r.toFixed(1)+'</span><span class="card-reviews">('+fmt(p.rv)+')</span></div>'
        +'</div>'
      +'</div>'
      +'<div class="card-footer">'
        +'<div class="card-tags">'+cu+'</div>'
        +'<a class="btn-maps" href="'+esc(mapsUrl)+'" target="_blank" rel="noopener" onclick="event.stopPropagation()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#EA4335"/><circle cx="12" cy="9" r="2.5" fill="#fff"/></svg>Google Maps</a>'
      +'</div>'
      +'<span class="fav-star'+(faved?' active':'')+'" data-id="'+p.id+'" onclick="toggleFav(\''+p.id+'\',event)">'+(faved?'‚òÖ':'‚òÜ')+'</span>'
    +'</div>';
  }).join('');
}

function renderList(){
  var g=document.getElementById('grid'),l=document.getElementById('lview'),em=document.getElementById('empty');
  g.style.display='none';l.style.display='block';
  if(!FLT.length){l.style.display='none';em.style.display='';return}em.style.display='none';
  var hasGeo=geoOrigin&&geoRadius>0;
  var cols=[{k:null,l:'#'},{k:'name',l:'Name'},{k:null,l:'Stadt'},{k:null,l:'Kategorie'},{k:'rating',l:'Bewertung'},{k:'reviewCount',l:'Anzahl'}];
  if(hasGeo)cols.push({k:'distance',l:'Entfernung'});
  cols.push({k:null,l:''});
  var headHTML='<tr>';
  cols.forEach(function(c){
    var sd=c.k&&c.k===sort.k;var ar=sd?(sort.d==='asc'?'‚Üë':'‚Üì'):'‚Üï';
    headHTML+='<th class="'+(sd?'sd':'')+' '+(c.k?'sort':'')+'" '+(c.k?'onclick="listSort(\''+c.k+'\')"':'')+'>'+c.l+(c.k?'<span class="sa">'+ar+'</span>':'')+'</th>';
  });
  headHTML+='</tr>';
  document.getElementById('lhead').innerHTML=headHTML;
  var start=(page-1)*PER,slice=FLT.slice(start,start+PER);
  document.getElementById('lbody').innerHTML=slice.map(function(p,i){
    var globalRank=start+i+1;
    var link=getMapsUrl(p);
    var kr=getKreis(p.addr);
    var cityD=kr?esc(p.city)+' <span class="kreis">K'+kr+'</span>':esc(p.city);
    var distCell='';
    if(hasGeo){var d=p._dist;distCell='<td>'+((d!=null&&d>=0)?(d<1?Math.round(d*1000)+' m':d.toFixed(1)+' km'):'‚Äì')+'</td>'}
    return '<tr><td style="font-weight:700;color:var(--primary);text-align:center;font-size:.78rem">'+globalRank+'</td><td class="nc" onclick="openModal(\''+p.id+'\')">'+esc(p.name)+'</td><td class="ac">'+cityD+'</td><td><span class="tag" style="font-size:.7rem">'+(TRADE_I[p.trade]||'')+' '+(p.trade||'‚Äì')+'</span></td><td><span class="stars" style="display:inline-flex;vertical-align:middle">'+stars(p.r,11)+'</span> '+p.r.toFixed(1)+'</td><td>'+fmt(p.rv)+'</td>'+distCell+'<td class="link-cell"><a href="'+link+'" target="_blank" rel="noopener">Maps ‚Üó</a></td></tr>';
  }).join('');
}

function listSort(k){if(sort.k===k)sort.d=sort.d==='asc'?'desc':'asc';else sort={k:k,d:k==='name'?'asc':'desc'};buildSortMenu();page=1;apply()}
function setView(v){view=v;document.getElementById('vGrid').classList.toggle('on',v==='grid');document.getElementById('vList').classList.toggle('on',v==='list');render()}

function renderPag(){
  var tot=Math.ceil(FLT.length/PER),el=document.getElementById('pag');
  if(tot<=1){el.innerHTML='';return}
  var h='<button class="pb" '+(page===1?'disabled':'')+' onclick="goPage('+(page-1)+')">‚Äπ</button>';
  var rng=[];if(tot<=7){for(var i=1;i<=tot;i++)rng.push(i)}else{rng.push(1);if(page>3)rng.push('‚Ä¶');for(var j=Math.max(2,page-1);j<=Math.min(tot-1,page+1);j++)rng.push(j);if(page<tot-2)rng.push('‚Ä¶');rng.push(tot)}
  rng.forEach(function(p){if(p==='‚Ä¶')h+='<span class="pi">‚Ä¶</span>';else h+='<button class="pb '+(p===page?'on':'')+'" onclick="goPage('+p+')">'+p+'</button>'});
  h+='<button class="pb" '+(page===tot?'disabled':'')+' onclick="goPage('+(page+1)+')">‚Ä∫</button>';
  h+='<span class="pi">'+(((page-1)*PER)+1)+'‚Äì'+Math.min(page*PER,FLT.length)+' von '+fmt(FLT.length)+'</span>';
  el.innerHTML=h;
}
function goPage(p){page=p;render();window.scrollTo({top:160,behavior:'smooth'})}
function updCount(){document.getElementById('rcnt').innerHTML='<b>'+fmt(FLT.length)+'</b> von '+fmt(ALL.length)+' Betrieben'}

// ‚îÄ‚îÄ CHIPS (DOM-based) ‚îÄ‚îÄ
function updChips(){
  var el=document.getElementById('chips');
  while(el.firstChild)el.removeChild(el.firstChild);
  var count=0;
  function addChip(label,action){
    count++;
    var span=document.createElement('span');span.className='chip';
    span.appendChild(document.createTextNode(label+' '));
    var btn=document.createElement('button');btn.className='chip-x';btn.textContent='‚úï';
    btn.addEventListener('click',function(e){e.stopPropagation();action();page=1;apply()});
    span.appendChild(btn);
    el.appendChild(span);
  }
  if(fl.s)addChip('"'+fl.s+'"',function(){fl.s='';document.getElementById('si').value=''});
  if(fl.stadtZh)addChip('üèôÔ∏è Stadt Z√ºrich',function(){fl.stadtZh=false;document.getElementById('btnStadtZh').classList.remove('on')});
  if(fl.winterthur)addChip('üèôÔ∏è Winterthur',function(){fl.winterthur=false;document.getElementById('btnWinti').classList.remove('on')});
  fl.tr.forEach(function(t){addChip((TRADE_I[t]||'')+' '+t,function(){togF('tr',t,document.querySelector('[data-k="tr"][data-v="'+t+'"]'))})});
  fl.cu.forEach(function(c){var cm=CMAP[c];addChip((cm?cm.i:'')+' '+(cm?cm.l:c),function(){togF('cu',c,document.querySelector('[data-k="cu"][data-v="'+c+'"]'))})});
  if(fl.mr>1)addChip('‚â•'+fl.mr.toFixed(1)+'‚òÖ',function(){fl.mr=1;document.getElementById('ratingSlider').value=1;document.getElementById('ratingVal').textContent='1.0'});
  if(fl.mv>40)addChip('‚â•'+fl.mv+' Bew.',function(){fl.mv=40;document.getElementById('revSlider').value=0;document.getElementById('revVal').textContent='40'});
  if(geoOrigin&&geoRadius>0){var glabel=gpsActive?'GPS':'PLZ '+geoOrigin.plz;addChip('üìç '+glabel+' ¬∑ '+geoRadius+' km',function(){if(gpsActive)deactivateGPS();clearGeo()})}
  if(count>1){var clr=document.createElement('button');clr.className='chip-clear';clr.textContent='Alle ‚úï';clr.addEventListener('click',function(){clearAll()});el.appendChild(clr)}
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(id){
  var p=ALL.find(function(x){return x.id===id});if(!p)return;
  var bd=document.getElementById('mbody');
  var link=getMapsUrl(p);
  var cuisines=p.cuisines.map(function(c){var cm=CMAP[c];return '<span class="tag" style="font-size:.72rem">'+(cm?cm.i:'')+' '+(cm?cm.l:c)+'</span>'}).join('');
  var trade=p.trade?'<span class="tag" style="font-size:.72rem;background:var(--primary-light);color:var(--primary)">'+(TRADE_I[p.trade]||'')+' '+p.trade+'</span>':'';
  var kr=kreisTag(p.addr);
  var mdist='';if(geoOrigin&&p._dist>=0){var d=p._dist;mdist='<div class="m-row" style="color:var(--gold);font-weight:600"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>'+(d<1?Math.round(d*1000)+' m':d.toFixed(1)+' km')+(gpsActive?' von GPS-Standort':' von PLZ '+geoOrigin.plz)+'</div>'}
  bd.innerHTML='<div class="m-name">'+esc(p.name)+'</div><div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem"><div class="stars" style="color:var(--gold)">'+stars(p.r,17)+'</div><span style="font-weight:700;font-size:1.05rem">'+p.r.toFixed(1)+'</span><span style="color:var(--text3);font-size:.88rem">('+fmt(p.rv)+' Bewertungen)</span></div><div class="m-sec"><h4>Details</h4><div class="m-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>'+esc(p.addr||'‚Äì')+' '+kr+'</div>'+mdist+(p.ph?'<div class="m-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg><a href="tel:'+p.ph+'" style="color:var(--primary);font-weight:500">'+esc(p.ph)+'</a></div>':'')+(p.web?'<div class="m-row"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg><a href="'+p.web+'" target="_blank" rel="noopener" style="color:var(--primary);font-weight:500;word-break:break-all">'+p.web.replace(/^https?:\/\/(www\.)?/,'').substring(0,45)+'</a></div>':'')+'</div><div class="m-sec"><h4>Kategorien</h4><div class="tg" style="gap:.25rem">'+trade+cuisines+'</div></div><div class="m-cta">'+(link?'<a href="javascript:void(0)" onclick="openMaps(\''+esc(link).replace(/'/g,"\\'")+'\','+(p.lat||0)+','+(p.lng||0)+',\''+(p.name||'').replace(/'/g,"\\'")+'\')" class="btn-p">üìç Auf Google Maps</a>':'')+(p.web?'<a href="'+p.web+'" target="_blank" rel="noopener" class="btn-s">üåê Website besuchen</a>':'')+'</div>';
  document.getElementById('modal').classList.add('on');document.body.style.overflow='hidden';
}
function closeModal(){document.getElementById('modal').classList.remove('on');document.body.style.overflow=''}
document.addEventListener('keydown',function(e){if(e.key==='Escape')closeModal()});
function toggleMF(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('fov').classList.toggle('on')}

// ‚îÄ‚îÄ EXPORT CSV ‚îÄ‚îÄ
function doExportCSV(){
  if(!FLT.length)return;document.getElementById('expMenu').classList.remove('on');
  var hdr='Name,Adresse,Stadt,Kreis,Kategorie,K√ºche,Rating,Bewertungen,Telefon,Website,Google Maps';
  var lines=[hdr];
  FLT.forEach(function(p){
    var cu=p.cuisines.map(function(c){return(CMAP[c]||{}).l||c}).join('; ');
    var link=getMapsUrl(p);
    var kr=getKreis(p.addr);
    lines.push('"'+(p.name||'').replace(/"/g,'""')+'","'+(p.addr||'').replace(/"/g,'""')+'","'+p.city+'",'+(kr?'Kreis '+kr:'')+','+p.trade+',"'+cu+'",'+p.r+','+p.rv+',"'+(p.ph||'')+'",'+p.web+','+link);
  });
  var csv='\uFEFF'+lines.join('\r\n');
  var blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='Z√ºriHub-Export-'+FLT.length+'.csv';
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(a.href);
}

// ‚îÄ‚îÄ EXPORT PDF ‚îÄ‚îÄ
function doExportPDF(){
  if(!FLT.length)return;document.getElementById('expMenu').classList.remove('on');
  if(!_pdfReady||typeof window.jspdf==='undefined'){
    alert('PDF-Bibliothek wird noch geladen‚Ä¶ Bitte in wenigen Sekunden erneut versuchen.');
    var s1=document.createElement('script');s1.src='https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js';
    s1.onload=function(){var s2=document.createElement('script');s2.src='https://unpkg.com/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js';s2.onload=function(){if(window.jspdf)_pdfReady=true};document.head.appendChild(s2)};
    document.head.appendChild(s1);return}
  try{
    var jsPDF=window.jspdf.jsPDF;
    var doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
    var W=doc.internal.pageSize.getWidth(),H=doc.internal.pageSize.getHeight();
    doc.setFillColor(15,71,175);doc.rect(0,0,W,22,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(16);doc.setTextColor(255,255,255);
    doc.text('Z√ºriHub ‚Äì Gastronomie-Export',14,14);
    doc.setFontSize(9);doc.setFont('helvetica','normal');
    doc.text(fmt(FLT.length)+' Betriebe | '+new Date().toLocaleDateString('de-CH'),14,19.5);
    var fi=[];
    if(fl.s)fi.push('Suche: "'+fl.s+'"');
    fl.tr.forEach(function(t){fi.push(t)});fl.cu.forEach(function(c){fi.push((CMAP[c]||{}).l||c)});
    if(fl.stadtZh)fi.push('Stadt Z√ºrich');if(fl.winterthur)fi.push('Winterthur');
    if(fl.mr>1)fi.push('>='+fl.mr.toFixed(1)+' Sterne');if(fl.mv>40)fi.push('>='+fl.mv+' Bew.');
    if(fi.length){doc.setFontSize(8);doc.setTextColor(200,210,230);doc.text('Filter: '+fi.join(' | '),W-14,14,{align:'right'})}
    var max=Math.min(FLT.length,2000);
    var rows=FLT.slice(0,max).map(function(p,i){
      var kr=getKreis(p.addr);
      return[(i+1)+'.',p.name||'-',(kr?p.city+' K'+kr:p.city)||'-',p.trade||'-',
        p.cuisines.slice(0,2).map(function(c){return(CMAP[c]||{}).l||''}).join(', ')||'-',
        p.r.toFixed(1),fmt(p.rv),p.ph||'-',p.web?p.web.replace(/^https?:\/\/(www\.)?/,'').substring(0,28):'-'];
    });
    doc.autoTable({startY:26,head:[['#','Name','Stadt','Kat.','K√ºche','Rating','Bew.','Telefon','Website']],body:rows,
      styles:{font:'helvetica',fontSize:7.5,cellPadding:2,lineColor:[212,220,232],lineWidth:0.2},
      headStyles:{fillColor:[15,71,175],textColor:[255,255,255],fontStyle:'bold',fontSize:7.5},
      alternateRowStyles:{fillColor:[242,245,252]},
      columnStyles:{0:{cellWidth:8,halign:'right',textColor:[136,150,166]},1:{cellWidth:52,fontStyle:'bold'},2:{cellWidth:30},3:{cellWidth:20},4:{cellWidth:35},5:{cellWidth:14,halign:'center'},6:{cellWidth:14,halign:'right'},7:{cellWidth:28},8:{cellWidth:42,textColor:[15,71,175]}},
      margin:{left:10,right:10},
      didDrawPage:function(){doc.setFontSize(7);doc.setTextColor(150,150,150);doc.text('Z√ºriHub ‚Äì Seite '+doc.internal.getCurrentPageInfo().pageNumber,W/2,H-6,{align:'center'})}
    });
    if(max<FLT.length){var y=(doc.lastAutoTable?doc.lastAutoTable.finalY:26)+8;doc.setFontSize(8);doc.setTextColor(100,100,100);doc.text('Hinweis: Export auf '+fmt(max)+' von '+fmt(FLT.length)+' Eintraegen limitiert.',14,y)}
    doc.save('Z√ºriHub-Export-'+FLT.length+'.pdf');
  }catch(err){console.error('PDF Error:',err);alert('PDF-Export fehlgeschlagen: '+err.message)}
}

init();
</script>
</body>
</html>
